name: DevSecOps Full Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  guvenlik-taramasi:
    runs-on: ubuntu-latest

    steps:
      # 1. KodlarÄ± Getir
      - name: Kodlari Getir
        uses: actions/checkout@v3

      # 2. SAST - Semgrep ile Kod Analizi (YENÄ° EKLENDÄ°) ğŸ›¡ï¸
      - name: Semgrep SAST Analizi
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/python # Sadece Python kurallarÄ± (HÄ±zlÄ± olsun)
          # config: p/default # Ä°stersen genel kurallarÄ± da aÃ§abilirsin

      # 3. SCA - Trivy ile KÃ¼tÃ¼phane TaramasÄ±
      - name: Trivy Dosya Taramasi (SCA)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      # 4. Hedef Sistemi Ayaga Kaldir (DVWA)
      - name: Hedef Uygulamayi Baslat (Docker)
        run: |
          docker pull vulnerables/web-dvwa
          docker run -d -p 80:80 vulnerables/web-dvwa
          sleep 10 

      # 5. DAST - OWASP ZAP TaramasÄ±
      - name: OWASP ZAP Taramasi (DAST)
        run: |
          chmod 777 $(pwd)
          docker run -u 0 --network host -v $(pwd):/zap/wrk/:rw -t zaproxy/zap-stable zap-baseline.py -t http://localhost -r zap_report.html
        continue-on-error: true

      # 6. Raporu Yukle
      - name: ZAP Raporunu Yukle
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-Guvenlik-Raporu
          path: zap_report.html
